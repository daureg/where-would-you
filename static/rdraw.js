function barycenter(e){for(var n=0,o=0,t=e.length,r=t-1;r>=0;r--)n+=e[r].lat,o+=e[r].lng;return new L.LatLng(n/t,o/t)}function format_venues(e,n){for(var o='<div id="venues"><p>Are you thinking of any of these places:<ul>',t=e.length-1;t>=0;t--){var r=e[t].url.substr(25);o+="<li>",o+='<input name="'+r+'" type="checkbox">&nbsp;',o+='<a href="'+e[t].url+'">'+e[t].name+"</a>",o+="</li>"}return o+='</ul><button class="pure-button" id="y_'+n+'">Yes</button>&nbsp;',o+='<button class="pure-button" id="n_'+n+'">No</button></p></div>'}function compute_bound(e){var n=.01,o=new L.LatLng(e[0][0]-n,e[0][1]-n),t=new L.LatLng(e[2][0]+n,e[2][1]+n);return new L.LatLngBounds(o,t)}function create_map(e,n,o,t){var r=new L.Map(e,{zoom:14,minZoom:10,center:n,layers:[o],maxBounds:bbounds}).fitBounds(bbounds);return L.polygon(t,{fill:!1,weight:3}).addTo(r),$("#loading").hide(),$(".spinner").hide(),r}function done_answering(){map.removeControl(drawControl),map.dragging.disable(),$("#time").show(),$("#done-ctn").hide(),$("#skip").hide(),carto_layer.setOpacity(.5)}function collect_time_answer(){for(var e=$("#time input"),n={hour:null},o=0;o<e.length;o++)"range"==e[o].type&&HOUR_WAS_CHANGED?n.hour=parseInt(e[o].value):n[e[o].value]=e[o].checked;return n}function submit_answer(e,n){var o=$.toJSON(collect_time_answer()),t=$.toJSON(ANSWER);$.request("post",$SCRIPT_ROOT+window.location.pathname,{nq:e,timing:o,ans:t}).then(function(){window.location=window.location.origin+"/"+e+"/"+n}).error(function(){})}function focus_on_popup(){map.removeControl(drawControl),map.dragging.disable(),$("#done-ctn").hide(),$("#skip").hide()}function close_popup(e){map.closePopup(e),map.addControl(drawControl),map.dragging.enable(),$("#done-ctn").show(),3===ANSWER.length&&done_answering()}function getTarget(e){var n,o=e;return o.target?n=o.target:o.srcElement&&(n=o.srcElement),3==n.nodeType&&(n=n.parentNode),n}var MINI=require("minified"),$=MINI.$;$("#question").show();var bbox=$BBOX,bbounds=compute_bound(bbox),OpenStreetMap_Mapnik=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}),carto_layer=OpenStreetMap_Mapnik,center=new L.LatLng(.5*(bbox[0][0]+bbox[2][0]),.5*(bbox[0][1]+bbox[2][1])),map=null;map=create_map("map",center,carto_layer,bbox);var drawnItems=new L.FeatureGroup;map.addLayer(drawnItems),L.drawLocal.draw.handlers.polyline.error="Please, use only simple shape!",L.drawLocal.edit.toolbar.buttons.edit="Modify areas.",L.drawLocal.edit.toolbar.buttons.editDisabled="No area to modify yet.",L.drawLocal.edit.handlers.edit.tooltip.text="Drag handles to modify area.";var drawControl=new L.Control.Draw({position:"topleft",draw:{polyline:!1,marker:!1,polygon:{shapeOptions:{color:"#2ecc40"},allowIntersection:!1,showArea:!1},circle:{shapeOptions:{color:"#2ecc40"},showRadius:!1}},edit:!1});map.addControl(drawControl),map.on("draw:created",function(e){var n=e.layerType,o=e.layer,t=ANSWER.length,r=o.toGeoJSON().geometry;if(!(t>2)&&bbounds.contains(o.getBounds())){var a=0;"circle"===n?(a=o._mRadius,center=o._latlng):(n="polygon",center=barycenter(o._latlngs)),ANSWER.push({id_:t,type:n,geo:r,radius:a,venues:[]});var i={geo:JSON.stringify(r),radius:a};$.request("post",$SCRIPT_ROOT+"/venues",i).then(function(e){var n=$.parseJSON(e);if(n.r.length>0){var o=L.popup({closeButton:!1,closeOnClick:!1,keepInView:!0}).setLatLng(center).setContent(format_venues(n.r,t)).openOn(map);focus_on_popup(),$("#n_"+t).on("click",function(e){return e.preventDefault(),close_popup(o),!1}),$("#y_"+t).on("click",function(e){e.preventDefault();for(var n=$("#venues li input"),r=0;r<n.length;r++)n[r].checked&&ANSWER[t].venues.push(n[r].name);return close_popup(o),!1})}else $("#done-ctn").show(),3===ANSWER.length&&done_answering()}).error(function(){}),drawnItems.addLayer(o)}});var show_hour=document.getElementById("hour-value");$("#done").on("click",function(e){done_answering(),e.preventDefault()}),$("#hour").on("change",function(e){HOUR_WAS_CHANGED=!0,show_hour.innerHTML="&nbsp;"+getTarget(e).value});